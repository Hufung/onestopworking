<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | To-Do & Schedule</title>
    
    <!-- Google Fonts for a modern look (used by both apps) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- PeerJS Library for WebRTC (for To-Do app) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- Tailwind CSS (for Schedule app) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSS styles are embedded here -->
    <style>
        /* --- Base Styles & To-Do App --- */
        :root {
            --bg-color: #f7f8fc;
            --main-color: #ffffff;
            --primary-color: #6a5af9;
            --primary-light-color: #e8e6ff;
            --text-color: #1d1d1f;
            --text-light-color: #6e6e73;
            --border-color: #e5e5e5;
            --shadow-color: rgba(106, 90, 249, 0.15);
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --warning-color: #ff9500;
            --timer-bg-color: #1d1d1f;
            --input-bg-color: #fcfcfd;
        }

        body.dark-mode {
            --bg-color: #121212;
            --main-color: #1e1e1e;
            --text-color: #e1e1e1;
            --text-light-color: #8e8e8e;
            --border-color: #333333;
            --shadow-color: rgba(106, 90, 249, 0.2);
            --timer-bg-color: #000000;
            --input-bg-color: #2a2a2a;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- Tab Navigation --- */
        .app-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background-color: var(--main-color);
            padding: 8px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        .app-nav button {
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background-color: transparent;
            color: var(--text-light-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .app-nav button.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        #todo-view-wrapper, #schedule-view-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
        }
        
        /* --- Class Input Modal --- */
        #class-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--main-color);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-content h2 { color: var(--text-color); font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; }
        .modal-content p { color: var(--text-light-color); margin-bottom: 20px; }
        #class-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 20px;
            text-align: center;
            background-color: var(--input-bg-color);
            color: var(--text-color);
        }
        #class-form button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- To-Do App Specific Styles --- */
        #todo-view-wrapper .container { background: var(--main-color); padding: 40px; border-radius: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05); width: 100%; max-width: 800px; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; position: relative; overflow: hidden; }
        
        #todo-view-wrapper #main-view {
            padding-top: 40px;
        }
        
        #todo-view-wrapper h1, #todo-view-wrapper #main-view h2 { text-align: center; color: var(--text-color); margin-bottom: 20px; font-weight: 700; }
        
        #todo-view-wrapper h1 { 
            font-size: 2.25rem; 
            margin-top: 0;
        }
        #sharing-view h2, #file-transfer-view h2 { font-size: 1.5rem; margin-top: 0px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        
        #todo-view-wrapper .top-controls { position: absolute; top: 25px; right: 25px; display: flex; align-items: center; gap: 15px; z-index: 10; }
        #todo-view-wrapper .theme-switch-wrapper { display: flex; align-items: center; gap: 10px; color: var(--text-light-color); font-size: 0.9rem; font-weight: 500; }
        #todo-view-wrapper .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        #todo-view-wrapper .theme-switch input { opacity: 0; width: 0; height: 0; }
        #todo-view-wrapper .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        #todo-view-wrapper .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        #todo-view-wrapper input:checked + .slider { background-color: var(--primary-color); }
        #todo-view-wrapper input:focus + .slider { box-shadow: 0 0 1px var(--primary-color); }
        #todo-view-wrapper input:checked + .slider:before { transform: translateX(24px); }
        #timer-container { text-align: center; margin-bottom: 30px; background-color: var(--timer-bg-color); padding: 15px 20px; border-radius: 12px; border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.2), inset 0 0 5px rgba(0,0,0,0.5); transition: background-color 0.3s; }
        #timer { font-family: 'Courier New', Courier, monospace; font-size: 2.5rem; font-weight: bold; color: var(--success-color); letter-spacing: 2px; text-shadow: 0 0 5px var(--success-color), 0 0 10px var(--success-color); }
        #timer-date { display: block; font-family: 'Inter', sans-serif; font-size: 0.9rem; color: #a0a0a0; margin-top: 5px; text-shadow: none; letter-spacing: normal; }
        #task-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; align-items: center; }
        #task-form input[type="text"], .input-field { grid-column: 1 / -1; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 1rem; transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s, color 0.3s; background-color: var(--input-bg-color); color: var(--text-color); }
        #task-form input[type="text"]:focus, .input-field:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--shadow-color); outline: none; }
        #task-form input::placeholder, .input-field::placeholder { color: var(--text-light-color); opacity: 0.7; }
        .date-picker { display: flex; align-items: center; gap: 10px; background-color: var(--input-bg-color); padding: 10px 14px; border-radius: 12px; border: 1px solid var(--border-color); transition: background-color 0.3s, border-color 0.3s; }
        .date-picker label { font-weight: 500; color: var(--text-light-color); font-size: 0.9rem; white-space: nowrap; }
        #task-form input[type="date"] { padding: 4px; border: none; border-radius: 4px; background: transparent; font-family: inherit; font-size: 0.95rem; color: var(--text-color); width: 100%; }
        body.dark-mode #task-form input[type="date"] { color-scheme: dark; }
        .button, #task-form button { grid-column: 1 / -1; padding: 16px 20px; background: var(--primary-color); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s; }
        .button.green { background-color: var(--success-color); }
        .button.orange { background-color: var(--warning-color); }
        .button:hover, #task-form button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--shadow-color); }
        .button.green:hover { box-shadow: 0 6px 20px rgba(52, 199, 89, 0.3); background-color: #30b852; }
        .button.orange:hover { box-shadow: 0 6px 20px rgba(255, 149, 0, 0.3); background-color: #ff8c00; }
        #toggle-sharing-button, #toggle-file-transfer-button { position: relative; width: auto; padding: 10px 16px; background: var(--text-light-color); color: var(--bg-color); border: none; border-radius: 12px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s, transform 0.2s; }
        #toggle-sharing-button:hover, #toggle-file-transfer-button:hover { background-color: var(--text-color); transform: translateY(-1px); }
        #sharing-view, #file-transfer-view { display: none; }
        .back-button { background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 600; margin-bottom: 30px; transition: background-color 0.2s, color 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .back-button:hover { background-color: var(--input-bg-color); }
        #search-container { margin-bottom: 20px; }
        #search-input { width: 100%; }
        #task-list { list-style: none; padding: 0; margin: 0; }
        .task-item { display: flex; align-items: center; background: var(--main-color); padding: 15px 20px; border: 1px solid var(--border-color); border-radius: 16px; margin-bottom: 12px; transition: background-color 0.3s, box-shadow 0.3s, border-color 0.3s, opacity 0.3s, max-height 0.3s ease-in-out; gap: 15px; overflow: hidden; max-height: 100px; }
        .task-item.hidden { opacity: 0; max-height: 0; padding-top: 0; padding-bottom: 0; margin-bottom: 0; border-width: 0; }
        .task-item:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.04); border-color: #d8d8d8; }
        body.dark-mode .task-item:hover { border-color: #444; }
        .task-item.completed { background-color: #f7f7f7; }
        body.dark-mode .task-item.completed { background-color: #2c2c2c; }
        .task-item.completed .task-name, .task-item.completed .task-details label { text-decoration: line-through; color: var(--text-light-color); }
        .task-item .task-details { flex-grow: 1; }
        .task-name { font-size: 1.05rem; font-weight: 500; cursor: pointer; transition: color 0.3s; padding: 4px; border-radius: 6px; }
        .task-name:hover { background-color: var(--input-bg-color); }
        .task-info { font-size: 0.85em; color: var(--text-light-color); margin-top: 6px; }
        .complete-checkbox { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; accent-color: var(--primary-color); }
        .deadline-text { cursor: pointer; color: var(--danger-color); font-weight: 500; transition: color 0.3s; }
        .deadline-text:hover { text-decoration: underline; color: #d92b21; }
        .deadline-status { font-weight: 500; font-size: 0.85em; padding: 3px 8px; border-radius: 10px; color: white; margin-left: 8px; display: inline-block; vertical-align: middle; }
        .deadline-status.future { background-color: var(--success-color); opacity: 0.8; }
        .deadline-status.today { background-color: var(--warning-color); }
        .deadline-status.overdue { background-color: var(--danger-color); }
        .notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, top 0.3s; }
        .notification.show { opacity: 1; visibility: visible; top: 90px; }
        .notification.error { background-color: var(--danger-color); box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4); }
        .notification.reminder, .notification.info { background-color: var(--primary-color); box-shadow: 0 4px 15px var(--shadow-color); }
        .section-container { margin-top: 20px; padding: 20px; border: 1px solid var(--border-color); border-radius: 16px; display: flex; flex-direction: column; gap: 15px; }
        .section-part { display: flex; flex-direction: column; gap: 10px; }
        .section-part h3 { margin: 0 0 5px 0; font-size: 1.1rem; color: var(--text-color); }
        #active-peer-id-container { font-size: 0.9rem; color: var(--text-light-color); }
        #active-peer-id { font-weight: 600; color: var(--text-color); background-color: var(--input-bg-color); padding: 5px 10px; border-radius: 8px; user-select: all; cursor: copy; }
        #connection-status { font-weight: 500; padding: 8px 12px; border-radius: 8px; text-align: center; word-break: break-all; }
        #connection-status.disconnected { background-color: #ffebeb; color: var(--danger-color); }
        body.dark-mode #connection-status.disconnected { background-color: #4f2525; }
        #connection-status.connected { background-color: #e3fcef; color: var(--success-color); }
        body.dark-mode #connection-status.connected { background-color: #1c4b2a; }
        #received-files-list { list-style-type: none; padding: 0; margin: 0; }
        #received-files-list li { background-color: var(--input-bg-color); padding: 10px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        #received-files-list .download-link { text-decoration: none; color: white; background-color: var(--primary-color); padding: 5px 10px; border-radius: 6px; font-weight: 500; font-size: 0.85rem; }
        
        /* --- Calendar View Styles --- */
        .view-switcher { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .view-switcher button { padding: 8px 16px; font-size: 0.9rem; font-weight: 600; border-radius: 10px; border: 1px solid var(--border-color); background-color: transparent; color: var(--text-light-color); cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .view-switcher button.active { background-color: var(--primary-light-color); color: var(--primary-color); border-color: var(--primary-light-color); }
        #calendar-view { flex-direction: column; width: 100%;}
        #calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #calendar-header h2 { font-size: 1.5rem; font-weight: 700; margin: 0; }
        #calendar-header button { background: none; border: 1px solid var(--border-color); border-radius: 50%; width: 36px; height: 36px; font-size: 1.5rem; cursor: pointer; transition: background-color 0.2s; }
        #calendar-header button:hover { background-color: var(--input-bg-color); }
        #calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; color: var(--text-light-color); margin-bottom: 10px; font-size: 0.9rem; }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            height: 110px; 
            padding: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
            display: flex;
            flex-direction: column;
        }
        .calendar-day.other-month { color: var(--text-light-color); opacity: 0.5; }
        .calendar-day.current-day .day-number { font-weight: 700; color: white; background-color: var(--primary-color); border-radius: 50%; width: 24px; height: 24px; display: inline-flex; justify-content: center; align-items: center; }
        .calendar-tasks { margin-top: 8px; font-size: 0.8rem; display: flex; flex-direction: column; gap: 4px; flex-grow: 1; overflow-y: auto; }
        .calendar-task, .calendar-event {
            padding: 2px 6px;
            border-radius: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .calendar-task { background-color: var(--primary-light-color); color: var(--primary-color); }
        .calendar-event { background-color: var(--warning-color); color: white; opacity: 0.9; }
        .calendar-task.completed { text-decoration: line-through; opacity: 0.7; background-color: #e0e0e0; color: #666; }
        body.dark-mode .calendar-task.completed { background-color: #444; color: var(--text-light-color); }
        
        .cycle-day {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.85em;
            font-weight: 700;
            color: var(--text-light-color);
            background-color: var(--input-bg-color);
            padding: 2px 6px;
            border-radius: 6px;
            line-height: 1;
        }
        .day-number.holiday {
            color: var(--danger-color);
            font-weight: 700;
        }
        .calendar-day.current-day .day-number.holiday {
            background-color: var(--danger-color);
            color: white;
        }

        /* --- Tutorial Styles --- */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3000;
            background-color: transparent;
            display: none;
            transition: background-color 0.5s;
        }
        #tutorial-overlay.active {
             background-color: rgba(0, 0, 0, 0.2);
        }

        #tutorial-spotlight {
            position: absolute;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.2);
            transition: all 0.5s ease-in-out;
            pointer-events: none;
        }

        #tutorial-tooltip {
            position: absolute;
            background-color: var(--main-color);
            color: var(--text-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 350px;
            transition: all 0.5s ease-in-out;
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(10px);
        }
        #tutorial-tooltip.active {
            opacity: 1;
            transform: translateY(0);
        }

        #tutorial-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        #tutorial-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #tutorial-skip-btn {
            background: none;
            border: none;
            color: var(--text-light-color);
            cursor: pointer;
            font-weight: 600;
        }

        #tutorial-next-btn {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        #tutorial-step-counter {
            font-size: 0.9rem;
            color: var(--text-light-color);
            margin-right: 15px;
        }


        @media (max-width: 768px) {
            .app-container { padding: 15px; }
            #todo-view-wrapper .container { padding: 20px; }
            .calendar-day { height: 100px; padding: 5px; font-size: 0.8rem;}
            .calendar-task, .calendar-event { font-size: 0.7rem; padding: 1px 4px;}
        }
        @media (max-width: 600px) {
            .app-container { padding-top: 10px; }
            #todo-view-wrapper .container { padding: 20px; border-radius: 16px; }
            #todo-view-wrapper #main-view { padding-top: 50px; }
            #todo-view-wrapper h1 { font-size: 1.8rem; }
            #sharing-view h2, #file-transfer-view h2, #calendar-header h2 { font-size: 1.3rem; }
            #todo-view-wrapper .top-controls { top: 15px; right: 15px; gap: 8px; }
            #todo-view-wrapper .theme-switch-wrapper span { display: none; }
            #timer { font-size: 2rem; }
            #timer-date { font-size: 0.8rem; }
            #task-form { grid-template-columns: 1fr; }
            .task-item { padding: 12px 15px; gap: 10px; }
            .task-name { font-size: 1rem; }
            .back-button { margin-bottom: 20px; }
            #calendar-weekdays div { font-size: 0.7rem; }
            .calendar-day { height: 90px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Main Tab Navigation -->
        <nav class="app-nav">
            <button id="show-todo-btn" class="active">To-Do List</button>
            <button id="show-schedule-btn">Schedule</button>
        </nav>
        
        <div id="notification" class="notification"></div>

        <!-- Wrapper for To-Do App -->
        <div id="todo-view-wrapper">
            <div class="container">
                <div class="top-controls">
                    <button id="toggle-file-transfer-button">File Transfer</button>
                    <button id="toggle-sharing-button">Sharing</button>
                    <div class="theme-switch-wrapper">
                        <span>☀️</span>
                        <label class="theme-switch" for="theme-checkbox">
                            <input type="checkbox" id="theme-checkbox" />
                            <div class="slider"></div>
                        </label>
                        <span>🌙</span>
                    </div>
                </div>
                <div id="main-view">
                    <h1>My To-Do List</h1>
                    <div id="timer-container">
                        <span id="timer">00:00:00</span>
                        <span id="timer-date">Loading date...</span>
                    </div>
                    
                    <div class="view-switcher">
                        <button id="show-list-view-btn" class="active">List</button>
                        <button id="show-calendar-view-btn">Calendar</button>
                    </div>

                    <div id="list-view">
                        <form id="task-form">
                            <input type="text" id="task-name-input" class="input-field" placeholder="What do you need to do?" required>
                            <div class="date-picker"> <label for="task-deadline-input">Deadline:</label> <input type="date" id="task-deadline-input"> </div>
                            <div class="date-picker"> <label for="task-finish-date-input">Finished:</label> <input type="date" id="task-finish-date-input"> </div>
                            <button type="submit">Add Task</button>
                        </form>
                        <div id="search-container"> <input type="text" id="search-input" class="input-field" placeholder="Search for a task..."> </div>
                        <ul id="task-list"></ul>
                    </div>
                    
                    <div id="calendar-view" style="display: none;">
                        <div id="calendar-header">
                            <button id="prev-month-btn">&lt;</button>
                            <h2 id="month-year-header"></h2>
                            <button id="next-month-btn">&gt;</button>
                        </div>
                        <div id="calendar-weekdays">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div id="calendar-grid"></div>
                    </div>

                </div>
                <div id="sharing-view">
                    <button class="back-button">← Back to Tasks</button>
                    <div class="section-container">
                        <h2>Real-Time Sharing</h2>
                        <div class="section-part">
                            <h3>Set Your Persistent ID</h3>
                            <input type="text" id="my-peer-id-input" class="input-field" placeholder="e.g., my-work-laptop">
                            <button id="set-peer-id-button" class="button orange">Set ID & Reconnect</button>
                            <div id="active-peer-id-container">Active ID: <span id="active-peer-id" title="Click to copy">Not connected</span></div>
                        </div>
                        <div class="section-part">
                            <h3>Connect to a Peer</h3>
                            <input type="text" id="remote-peer-id-input" class="input-field" placeholder="Enter peer's persistent ID">
                            <button id="connect-button" class="button green">Connect</button>
                            <div id="connection-status" class="disconnected">Status: Not Connected</div>
                        </div>
                    </div>
                </div>
                <div id="file-transfer-view">
                    <button class="back-button">← Back to Tasks</button>
                     <div class="section-container">
                         <h2>Peer-to-Peer File Transfer</h2>
                         <div class="section-part">
                             <h3>Send a File</h3>
                             <select id="peer-select" class="input-field"></select>
                             <input type="file" id="file-input" class="input-field">
                             <button id="send-file-button" class="button">Send File</button>
                         </div>
                         <div class="section-part">
                             <h3>Received Files</h3>
                             <ul id="received-files-list"></ul>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wrapper for Schedule App -->
        <div id="schedule-view-wrapper" style="display: none;">
            <div class="container mx-auto p-4 max-w-5xl">
                <header class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800">School Schedule</h1>
                    <p id="schedule-subtitle" class="text-gray-500 mt-2">Loading your schedule...</p>
                </header>
                <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-bold text-blue-600 mb-2">Today</h2>
                        <p id="today-date" class="font-medium text-gray-700 mb-4"></p>
                        <div id="today-events" class="space-y-3"><p class="text-gray-500">Loading events...</p></div>
                        <div id="today-timetable" class="mt-4"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h2 class="text-2xl font-bold text-green-600 mb-2">Tomorrow</h2>
                        <p id="tomorrow-date" class="font-medium text-gray-700 mb-4"></p>
                        <div id="tomorrow-events" class="space-y-3"><p class="text-gray-500">Loading events...</p></div>
                         <div id="tomorrow-timetable" class="mt-4"></div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Modal for Class Input -->
    <div id="class-modal" style="display: none;">
        <div class="modal-content">
            <h2>Enter Your Class</h2>
            <p>Please enter your class to fetch your schedule (e.g., 5D).</p>
            <form id="class-form">
                <input type="text" id="class-input" placeholder="e.g., 5D" required>
                <button type="submit">Save & View Schedule</button>
            </form>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay">
        <div id="tutorial-spotlight"></div>
        <div id="tutorial-tooltip">
            <div id="tutorial-text"></div>
            <div id="tutorial-nav">
                <button id="tutorial-skip-btn">Skip</button>
                <div>
                    <span id="tutorial-step-counter"></span>
                    <button id="tutorial-next-btn">Next</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Main application logic -->
    <script>
        // --- TAB SWITCHING LOGIC ---
        const showTodoBtn = document.getElementById('show-todo-btn');
        const showScheduleBtn = document.getElementById('show-schedule-btn');
        const todoWrapper = document.getElementById('todo-view-wrapper');
        const scheduleWrapper = document.getElementById('schedule-view-wrapper');

        showTodoBtn.addEventListener('click', () => {
            todoWrapper.style.display = 'flex';
            scheduleWrapper.style.display = 'none';
            showTodoBtn.classList.add('active');
            showScheduleBtn.classList.remove('active');
        });
        showScheduleBtn.addEventListener('click', () => {
            todoWrapper.style.display = 'none';
            scheduleWrapper.style.display = 'block';
            showScheduleBtn.classList.add('active');
            showTodoBtn.classList.remove('active');
        });
        
        // --- TO-DO APP LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- TUTORIAL LOGIC ---
            const tutorialOverlay = document.getElementById('tutorial-overlay');
            if (tutorialOverlay) {
                const hasVisited = localStorage.getItem('hasVisitedBefore');

                if (!hasVisited) {
                    const spotlight = document.getElementById('tutorial-spotlight');
                    const tooltip = document.getElementById('tutorial-tooltip');
                    const tutorialText = document.getElementById('tutorial-text');
                    const stepCounter = document.getElementById('tutorial-step-counter');
                    const nextBtn = document.getElementById('tutorial-next-btn');
                    const skipBtn = document.getElementById('tutorial-skip-btn');
                    
                    let currentStep = 0;

                    const steps = [
                        {
                            element: null, 
                            text: "Welcome to your Dashboard! Let's take a quick tour of the features.",
                            position: 'center'
                        },
                        {
                            element: '.app-nav',
                            text: "Use these tabs to switch between your 'To-Do List' and your 'School Schedule'.",
                            position: 'bottom'
                        },
                        {
                            element: '#task-form',
                            text: "Here you can add new tasks. Just type a name, pick a deadline, and click 'Add Task'.",
                            position: 'bottom'
                        },
                        {
                            element: '.view-switcher',
                            text: "You can view your tasks as a simple list or on a full calendar.",
                            position: 'bottom'
                        },
                        {
                            element: '.top-controls',
                            text: "Use these buttons to share your to-do list in real-time or transfer files with a peer.",
                            position: 'bottom'
                        },
                        {
                            element: '#show-schedule-btn',
                            text: "Now, let's check the Schedule app. Click 'Next' and we'll switch over.",
                            position: 'bottom',
                            action: () => showScheduleBtn.click()
                        },
                        {
                            element: '#schedule-view-wrapper .container',
                            text: "The first time you visit, you'll be asked for your class (e.g., 5D) to fetch the correct timetable.",
                            position: 'top'
                        },
                        {
                            element: null,
                            text: "That's it! You're all set. Enjoy using your dashboard.",
                            position: 'center'
                        }
                    ];

                    function endTutorial() {
                        tutorialOverlay.classList.remove('active');
                        tooltip.classList.remove('active');
                        setTimeout(() => {
                            tutorialOverlay.style.display = 'none';
                        }, 500);
                        localStorage.setItem('hasVisitedBefore', 'true');
                        
                        const savedClass = localStorage.getItem('userClass');
                        if (!savedClass) {
                            document.getElementById('class-modal').style.display = 'flex';
                        }
                    }

                    function showStep(stepIndex) {
                        if (stepIndex >= steps.length) {
                            endTutorial();
                            return;
                        }
                        
                        const step = steps[stepIndex];
                        
                        if (step.action) {
                            step.action();
                        }

                        tooltip.classList.remove('active');
                        
                        const targetElement = step.element ? document.querySelector(step.element) : null;

                        if(targetElement) {
                             targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                        } else {
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                        
                        setTimeout(() => {
                            tutorialText.innerHTML = step.text;
                            stepCounter.textContent = `${stepIndex + 1} / ${steps.length}`;
                            
                            if (stepIndex === steps.length - 1) {
                                nextBtn.textContent = 'Finish';
                            } else {
                                nextBtn.textContent = 'Next';
                            }
                            
                            if (targetElement) {
                                const rect = targetElement.getBoundingClientRect();
                                
                                spotlight.style.display = 'block';
                                spotlight.style.width = `${rect.width + 20}px`;
                                spotlight.style.height = `${rect.height + 20}px`;
                                spotlight.style.top = `${rect.top - 10}px`;
                                spotlight.style.left = `${rect.left - 10}px`;
                                
                                let tooltipTop, tooltipLeft;

                                if (step.position === 'bottom') {
                                    tooltipTop = rect.bottom + 20;
                                } else if (step.position === 'top') {
                                    tooltipTop = rect.top - tooltip.offsetHeight - 20;
                                }
                                tooltipLeft = rect.left + rect.width / 2 - tooltip.offsetWidth / 2;

                                if (tooltipLeft < 10) tooltipLeft = 10;
                                if (tooltipLeft + tooltip.offsetWidth > window.innerWidth - 10) {
                                    tooltipLeft = window.innerWidth - tooltip.offsetWidth - 10;
                                }
                                if (tooltipTop < 10) tooltipTop = 10;
                                if (tooltipTop + tooltip.offsetHeight > window.innerHeight - 10) {
                                    tooltipTop = window.innerHeight - tooltip.offsetHeight - 10;
                                }
                                
                                tooltip.style.top = `${tooltipTop}px`;
                                tooltip.style.left = `${tooltipLeft}px`;
                                tooltip.style.transform = 'translate(0, 0)';

                            } else { 
                                spotlight.style.display = 'none';
                                tooltip.style.top = '50%';
                                tooltip.style.left = '50%';
                                tooltip.style.transform = 'translate(-50%, -50%)';
                            }
                            tooltip.classList.add('active');
                        }, 600); 
                    }

                    nextBtn.onclick = () => {
                        currentStep++;
                        showStep(currentStep);
                    };

                    skipBtn.onclick = endTutorial;
                    
                    setTimeout(() => {
                         tutorialOverlay.style.display = 'block';
                         setTimeout(() => { 
                            tutorialOverlay.classList.add('active');
                            showStep(currentStep);
                         }, 10);
                    }, 500);
                }
            }


            const taskForm = document.getElementById('task-form');
            if (!taskForm) return;

            // --- School Schedule Data (for Calendar) ---
            const csvData = `e,DayOfWeek,CycleDay,Type, Ceremony"\n2025-09-02,Tuesday,A,,Summer Timetable\n2025-09-03,Wednesday,C,,Summer Timetable\n2025-09-04,Thursday,F,,Summer Timetable\n2025-09-05,Friday,B,,Summer Timetable\n2025-09-06,Saturday,,,\n2025-09-07,Sunday,,,\n2025-09-08,Monday,D,,Summer Timetable\n2025-09-09,Tuesday,E,,Summer Timetable\n2025-09-10,Wednesday,G,,Summer Timetable\n2025-09-11,Thursday,H,,Summer Timetable\n2025-09-12,Friday,A,,Summer Timetable\n2025-09-13,Saturday,,,\n2025-09-14,Sunday,,Special Timetable,"Education Sunday"\n2025-09-15,Monday,B,,Summer Timetable\n2025-09-16,Tuesday,C,,Summer Timetable\n2025-09-17,Wednesday,D,,Summer Timetable\n2025-09-18,Thursday,E,,Summer Timetable\n2025-09-19,Friday,F,,Summer Timetable\n2025-09-20,Saturday,,,\n2025-09-21,Sunday,,,\n2025-09-22,Monday,G,,Summer Timetable\n2025-09-23,Tuesday,H,,Summer Timetable\n2025-09-24,Wednesday,A,,\n2025-09-25,Thursday,B,,\n2025-09-26,Friday,C,,\n2025-09-27,Saturday,,,\n2025-09-28,Sunday,,,\n2025-09-29,Monday,,,\n2025-09-30,Tuesday,,,\n2025-10-01,Wednesday,,School Holiday,"The National Day"\n2025-10-02,Thursday,F,,\n2025-10-03,Friday,G,,\n2025-10-04,Saturday,,,\n2025-10-05,Sunday,,,\n2025-10-06,Monday,H,,\n2025-10-07,Tuesday,,School Holiday,"The day following the Mid-Autumn Festival"\n2025-10-08,Wednesday,A,,\n2025-10-09,Thursday,B,,\n2025-10-10,Friday,C,,\n2025-10-11,Saturday,,,\n2025-10-12,Sunday,,,\n2025-10-13,Monday,D,,\n2025-10-14,Tuesday,E,,\n2025-10-15,Wednesday,F,,\n2025-10-16,Thursday,G,,\n2025-10-17,Friday,H,,\n2025-10-18,Saturday,,,\n2025-10-19,Sunday,,,\n2025-10-20,Monday,,Special Timetable,"Swimming Gala"\n2025-10-21,Tuesday,A,,"S6 Study Day; Staff Development (pm)"\n2025-10-22,Wednesday,B,,"S6 First Examination"\n2025-10-23,Thursday,C,,"S6 First Examination"\n2025-10-24,Friday,D,Special Timetable,"S6 First Examination; PTA AGM cum S1-4 Parents' Meet (7:00 pm)"\n2025-10-25,Saturday,,,\n2025-10-26,Sunday,,,\n2025-10-27,Monday,E,,"S6 First Examination; S1-3 Test Week"\n2025-10-28,Tuesday,F,,"S6 First Examination; S1-3 Test Week"\n2025-10-29,Wednesday,,School Holiday,"S6 First Examination; S1-3 Test Week; Chung Yeung Festival"\n2025-10-30,Thursday,,,"S6 First Examination; S1-3 Test Week"\n2025-10-31,Friday,H,,"S6 First Examination; S1-3 Test Week"\n2026-02-28,Saturday,,Special Timetable,"S1-5 Parents' Days"\n2026-03-02,Monday,,School Holiday,"The day following Parents' Days"\n2026-06-19,Friday,,School Holiday,"Tuen Ng Festival"\n2026-07-01,Wednesday,,School Holiday,"Musical Rehearsal; HKSAR Establishment Day"`;
            function parseCSV(csvText) { const lines = csvText.trim().split('\n'); const headers = lines[0].split(','); const data = []; for (let i = 1; i < lines.length; i++) { const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); if (values.length === headers.length) { const entry = {}; for (let j = 0; j < headers.length; j++) { entry[headers[j]] = values[j].replace(/"/g, ''); } data.push(entry); } } return data; }
            const allSchoolEvents = parseCSV(csvData);

            // --- Element Selectors ---
            const taskNameInput = document.getElementById('task-name-input');
            const taskDeadlineInput = document.getElementById('task-deadline-input');
            const taskFinishDateInput = document.getElementById('task-finish-date-input');
            const taskList = document.getElementById('task-list');
            const timerElement = document.getElementById('timer');
            const timerDateElement = document.getElementById('timer-date');
            const notificationElement = document.getElementById('notification');
            const themeCheckbox = document.getElementById('theme-checkbox');
            const searchInput = document.getElementById('search-input');
            const mainView = document.getElementById('main-view');
            const sharingView = document.getElementById('sharing-view');
            const fileTransferView = document.getElementById('file-transfer-view');
            const toggleSharingButton = document.getElementById('toggle-sharing-button');
            const toggleFileTransferButton = document.getElementById('toggle-file-transfer-button');
            const backButtons = document.querySelectorAll('.back-button');
            const topControls = document.querySelector('.top-controls');
            const myPeerIdInput = document.getElementById('my-peer-id-input');
            const setPeerIdButton = document.getElementById('set-peer-id-button');
            const activePeerIdElement = document.getElementById('active-peer-id');
            const remotePeerIdInput = document.getElementById('remote-peer-id-input');
            const connectButton = document.getElementById('connect-button');
            const connectionStatusElement = document.getElementById('connection-status');
            const peerSelect = document.getElementById('peer-select');
            const fileInput = document.getElementById('file-input');
            const sendFileButton = document.getElementById('send-file-button');
            const receivedFilesList = document.getElementById('received-files-list');

            // --- Calendar Elements ---
            const showListViewBtn = document.getElementById('show-list-view-btn');
            const showCalendarViewBtn = document.getElementById('show-calendar-view-btn');
            const listView = document.getElementById('list-view');
            const calendarView = document.getElementById('calendar-view');
            const monthYearHeader = document.getElementById('month-year-header');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const calendarGrid = document.getElementById('calendar-grid');
            let calendarDate = new Date();

            let peer;
            const connections = [];

            // --- PeerJS & WebRTC Logic ---
            function getRecentPeers() { const p = localStorage.getItem('recentPeerIds'); return p ? JSON.parse(p) : []; }
            function addRecentPeer(peerId) { let p = getRecentPeers().filter(id => id !== peerId); p.unshift(peerId); if (p.length > 5) p.pop(); localStorage.setItem('recentPeerIds', JSON.stringify(p)); localStorage.setItem('lastConnectedPeerId', peerId); }
            function initializePeer(requestedId) { if (peer) peer.destroy(); peer = new Peer(requestedId); peer.on('open', (id) => { activePeerIdElement.textContent = id; activePeerIdElement.onclick = () => { navigator.clipboard.writeText(id); showNotification('Your active ID has been copied!', 'info'); }; const recent = getRecentPeers(); if (recent.length > 0) setTimeout(() => { showNotification('Reconnecting to recent peers...', 'info'); recent.forEach(connectToPeer); }, 500); }); peer.on('connection', (conn) => { showNotification(`Incoming connection from ${conn.peer}`, 'info'); setupConnection(conn); }); peer.on('error', (err) => { console.error('PeerJS error:', err); showNotification(err.type === 'unavailable-id' ? `ID "${requestedId}" is taken.` : `Connection error: ${err.message}`); activePeerIdElement.textContent = 'Error'; }); }
            setPeerIdButton.onclick = () => { const id = myPeerIdInput.value.trim(); if (!id) { showNotification('Please enter a persistent ID.'); return; } localStorage.setItem('myPeerId', id); showNotification(`Setting ID to "${id}"...`, 'info'); initializePeer(id); };
            const savedPeerId = localStorage.getItem('myPeerId');
            if (savedPeerId) { myPeerIdInput.value = savedPeerId; initializePeer(savedPeerId); } else { activePeerIdElement.textContent = "Set an ID to connect"; }
            function setupConnection(conn) { conn.on('open', () => { if (connections.some(c => c.peer === conn.peer)) { conn.close(); return; } connections.push(conn); updateConnectionStatus(); updatePeerSelectDropdown(); if (conn.metadata.isInitiator) addRecentPeer(conn.peer); conn.send({ type: 'SYNC_ALL', tasks: getTasks() }); }); conn.on('data', handleRemoteData); conn.on('close', () => { const index = connections.findIndex(c => c.peer === conn.peer); if (index > -1) connections.splice(index, 1); updateConnectionStatus(); updatePeerSelectDropdown(); showNotification(`Disconnected from ${conn.peer}`, 'info'); }); }
            function connectToPeer(remoteId) { if (!peer || peer.disconnected) { showNotification('You must set your ID before connecting.', 'error'); return; } if (!remoteId || remoteId === peer.id || connections.some(c => c.peer === remoteId)) return; showNotification(`Attempting to connect to ${remoteId}...`, 'info'); const conn = peer.connect(remoteId, { metadata: { isInitiator: true } }); setupConnection(conn); }
            connectButton.onclick = () => connectToPeer(remotePeerIdInput.value.trim());
            function updateConnectionStatus() { if (connections.length > 0) { const ids = connections.map(c => c.peer).join(', '); connectionStatusElement.innerHTML = `<strong>Connected to:</strong> ${ids}`; connectionStatusElement.className = 'connected'; } else { connectionStatusElement.textContent = 'Status: Not Connected'; connectionStatusElement.className = 'disconnected'; } }
            function broadcast(data) { connections.forEach(conn => { if (conn.open) conn.send(data); }); }
            function handleRemoteData(data) { if (data.type === 'FILE_TRANSFER') { handleReceivedFile(data); return; } let tasks = getTasks(); let updated = false; let index; switch (data.type) { case 'ADD_TASK': if (!tasks.some(t => t.id === data.task.id)) { tasks.push(data.task); updated = true; } break; case 'TOGGLE_COMPLETE': index = tasks.findIndex(t => t.id == data.taskId); if (index > -1) { Object.assign(tasks[index], { isCompleted: data.isCompleted, finishDate: data.finishDate }); updated = true; } break; case 'DELETE_TASK': const len = tasks.length; tasks = tasks.filter(t => t.id != data.taskId); if (tasks.length < len) updated = true; break; case 'UPDATE_TASK': index = tasks.findIndex(t => t.id == data.taskId); if (index > -1) { Object.assign(tasks[index], data.updatedFields); updated = true; } break; case 'SYNC_ALL': const map = new Map(tasks.map(t => [t.id, t])); data.tasks.forEach(rt => map.set(rt.id, rt)); tasks = Array.from(map.values()); updated = true; break; } if (updated) { saveTasks(tasks); loadTasks(); renderCalendar(); } }
            const lastPeerId = localStorage.getItem('lastConnectedPeerId'); if (lastPeerId) remotePeerIdInput.value = lastPeerId;
            function updatePeerSelectDropdown() { peerSelect.innerHTML = ''; if (connections.length === 0) { peerSelect.innerHTML = '<option>No peers connected</option>'; peerSelect.disabled = true; sendFileButton.disabled = true; } else { connections.forEach(conn => { peerSelect.innerHTML += `<option value="${conn.peer}">${conn.peer}</option>`; }); peerSelect.disabled = false; sendFileButton.disabled = false; } }
            sendFileButton.onclick = () => { const peerId = peerSelect.value; const file = fileInput.files[0]; if (!peerId || peerId === 'No peers connected') { showNotification('Please select a peer.'); return; } if (!file) { showNotification('Please select a file.'); return; } const conn = connections.find(c => c.peer === peerId); if (!conn) { showNotification('Connection lost.'); return; } const reader = new FileReader(); reader.onload = (event) => { conn.send({ type: 'FILE_TRANSFER', file: event.target.result, fileName: file.name, fileType: file.type }); showNotification(`Sending ${file.name} to ${peerId}...`, 'info'); }; reader.readAsArrayBuffer(file); };
            function handleReceivedFile({ file, fileName, fileType }) { const blob = new Blob([file], { type: fileType }); const url = URL.createObjectURL(blob); receivedFilesList.innerHTML += `<li><span>${fileName}</span><a href="${url}" download="${fileName}" class="download-link">Download</a></li>`; showNotification(`You received a file: ${fileName}`, 'info'); }
            
            // --- UI & View Logic ---
            function showView(viewToShow) { [mainView, sharingView, fileTransferView].forEach(v => v.style.display = 'none'); viewToShow.style.display = 'block'; topControls.style.display = (viewToShow === mainView) ? 'flex' : 'none'; }
            toggleSharingButton.onclick = () => showView(sharingView);
            toggleFileTransferButton.onclick = () => showView(fileTransferView);
            backButtons.forEach(button => button.onclick = () => showView(mainView));
            searchInput.oninput = (e) => { const term = e.target.value.toLowerCase(); taskList.querySelectorAll('.task-item').forEach(task => { const name = task.querySelector('.task-name').textContent.toLowerCase(); task.classList.toggle('hidden', !name.includes(term)); }); };
            function setTheme(theme) { document.body.classList.toggle('dark-mode', theme === 'dark'); themeCheckbox.checked = theme === 'dark'; localStorage.setItem('theme', theme); }
            themeCheckbox.onchange = () => setTheme(themeCheckbox.checked ? 'dark' : 'light');
            const savedTheme = localStorage.getItem('theme'); const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; setTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
            function showNotification(message, type = 'error') { notificationElement.textContent = message; notificationElement.className = `notification ${type} show`; setTimeout(() => { notificationElement.className = `notification ${type}`; }, 4000); }
            
            // --- Timer & Reminder Logic ---
            function updateTimer() { const now = new Date(); timerDateElement.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); timerElement.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }); }
            updateTimer(); setInterval(updateTimer, 1000);
            function checkReminders() { const tasks = getTasks(); const now = new Date(); now.setHours(0, 0, 0, 0); const reminded = JSON.parse(sessionStorage.getItem('remindedTasks')) || []; let delay = 0; tasks.forEach(task => { if (!task.isCompleted && !reminded.includes(task.id)) { const deadline = new Date(task.deadline + 'T00:00:00'); if (now.getTime() === deadline.getTime()) { setTimeout(() => { const name = escapeHTML(task.name).substring(0, 30) + (task.name.length > 30 ? '...' : ''); showNotification(`Reminder: "${name}" is due today!`, 'reminder'); }, delay); delay += 500; reminded.push(task.id); } } }); sessionStorage.setItem('remindedTasks', JSON.stringify(reminded)); }
            
            // --- Task CRUD Logic ---
            function truncateText(text, maxLength) { if (text.length <= maxLength) { return text; } return text.slice(0, maxLength) + '...'; }
            taskForm.onsubmit = (e) => { e.preventDefault(); const name = taskNameInput.value.trim(); const deadline = taskDeadlineInput.value; const finishDate = taskFinishDateInput.value; if (name === '' || deadline === '') { showNotification('Task name and deadline are required.'); return; } const task = { id: Date.now(), name, deadline, isCompleted: false, finishDate: finishDate || null }; let tasks = getTasks(); tasks.push(task); saveTasks(tasks); loadTasks(); renderCalendar(); broadcast({ type: 'ADD_TASK', task }); taskForm.reset(); taskNameInput.focus(); };
            taskList.onchange = (e) => { if (e.target.classList.contains('complete-checkbox')) { toggleComplete(Number(e.target.closest('.task-item').dataset.id)); } };
            taskList.onclick = (e) => { const item = e.target.closest('.task-item'); if (!item) return; const id = Number(item.dataset.id); if (e.target.closest('.deadline-text')) { item.style.transition = 'opacity 0.3s ease, transform 0.3s ease'; item.style.opacity = '0'; item.style.transform = 'translateX(-20px)'; setTimeout(() => deleteTask(id), 300); } else if (e.target.classList.contains('task-name')) makeEditable(e.target, id, 'name'); };
            function makeEditable(element, id, field) { const original = getTaskById(id)[field]; const input = document.createElement('input'); input.type = 'text'; input.value = original; input.className = 'edit-input-field'; element.replaceWith(input); input.focus(); const save = () => { const newValue = input.value.trim(); if (newValue && newValue !== original) { updateTask(id, { [field]: newValue }); } else { loadTasks(); renderCalendar(); } }; input.onblur = save; input.onkeydown = (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { loadTasks(); renderCalendar(); } }; }
            function addTaskToDOM(task) { const li = document.createElement('li'); li.className = `task-item ${task.isCompleted ? 'completed' : ''}`; li.dataset.id = task.id; const deadline = new Date(task.deadline + 'T00:00:00'); let status = ''; if (!task.isCompleted) { const now = new Date(); now.setHours(0, 0, 0, 0); const diff = Math.ceil((deadline - now) / 864e5); if (diff > 0) status = `<span class="deadline-status future">${diff} day${diff === 1 ? '' : 's'} left</span>`; else if (diff === 0) status = `<span class="deadline-status today">Due today</span>`; else { const overdue = Math.abs(diff); status = `<span class="deadline-status overdue">Overdue by ${overdue} day${overdue === 1 ? '' : 's'}</span>`; } } li.innerHTML = `<input type="checkbox" class="complete-checkbox" ${task.isCompleted ? 'checked' : ''}><div class="task-details"><div class="task-name" title="Click to edit">${escapeHTML(task.name)}</div><div class="task-info"><span class="deadline-text" title="Click to delete"><strong>Deadline:</strong> <span>${deadline.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}</span></span> ${status} | <strong>Finished:</strong> <span>${task.finishDate ? new Date(task.finishDate.includes('T') ? task.finishDate : task.finishDate + 'T00:00:00').toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) : 'Pending'}</span></div></div>`; taskList.appendChild(li); }
            function getTasks() { try { return JSON.parse(localStorage.getItem('tasks')) || []; } catch (e) { return []; } }
            function getTaskById(id) { return getTasks().find(task => task.id === id); }
            function saveTasks(tasks) { localStorage.setItem('tasks', JSON.stringify(tasks)); }
            function loadTasks() { const tasks = getTasks(); tasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline)); taskList.innerHTML = ''; tasks.forEach(addTaskToDOM); }
            function updateTask(id, fields) { let tasks = getTasks(); const index = tasks.findIndex(t => t.id == id); if (index > -1) { tasks[index] = { ...tasks[index], ...fields }; saveTasks(tasks); broadcast({ type: 'UPDATE_TASK', taskId: id, updatedFields: fields }); } loadTasks(); renderCalendar(); }
            function toggleComplete(id) { const tasks = getTasks(); const index = tasks.findIndex(t => t.id == id); if (index > -1) { const task = tasks[index]; task.isCompleted = !task.isCompleted; if (task.isCompleted) task.finishDate = task.finishDate || new Date().toISOString().split('T')[0]; saveTasks(tasks); broadcast({ type: 'TOGGLE_COMPLETE', taskId: id, isCompleted: task.isCompleted, finishDate: task.finishDate }); } loadTasks(); renderCalendar(); }
            function deleteTask(id) { let tasks = getTasks().filter(t => t.id != id); saveTasks(tasks); broadcast({ type: 'DELETE_TASK', taskId: id }); loadTasks(); renderCalendar(); }
            function escapeHTML(str) { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
            
            // --- Calendar Logic ---
            calendarGrid.addEventListener('click', (e) => {
                const target = e.target.closest('.calendar-task, .calendar-event');
                if (target) {
                    const fullName = target.getAttribute('title');
                    if (fullName) {
                        showNotification(fullName, 'info');
                    }
                }
            });

            function renderCalendar() {
                calendarGrid.innerHTML = '';
                const year = calendarDate.getFullYear();
                const month = calendarDate.getMonth();
                monthYearHeader.textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

                const tasks = getTasks();
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today for comparison

                const generateDayElement = (date, isCurrentMonth) => { // date is already normalized to midnight
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    if (!isCurrentMonth) {
                        dayEl.classList.add('other-month');
                    }
                    if (date.getTime() === today.getTime()) {
                        dayEl.classList.add('current-day');
                    }

                    const tasksForDay = tasks.filter(task => {
                        const parts = task.deadline.split('-'); // e.g. "2025-10-13"
                        // Create date as UTC to avoid timezone shift from string
                        const taskDeadline = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                        return taskDeadline.getTime() === date.getTime();
                    });
                    
                    let tasksHtml = tasksForDay.map(task => 
                        `<div class="calendar-task ${task.isCompleted ? 'completed' : ''}" title="${escapeHTML(task.name)}">${escapeHTML(truncateText(task.name, 10))}</div>`
                    ).join('');

                    const y = date.getFullYear();
                    const m = (date.getMonth() + 1).toString().padStart(2, '0');
                    const d = date.getDate().toString().padStart(2, '0');
                    const lookupDate = `${y}-${m}-${d}`;
                    const eventForDay = allSchoolEvents.find(e => e.Date === lookupDate);
                    let cycleDayHtml = '';
                    let holidayClass = '';
                    let eventsHtml = '';
                    const dayOfWeek = date.getDay(); 

                    if (eventForDay) {
                        if(eventForDay.CycleDay) {
                             cycleDayHtml = `<div class="cycle-day">${eventForDay.CycleDay}</div>`;
                        }
                        if(eventForDay.Type.includes('Holiday') || eventForDay.Events.includes('Holiday')) {
                            holidayClass = ' holiday';
                        }
                        if(eventForDay.Events) {
                            eventsHtml = eventForDay.Events.split(';').map(event => {
                                const trimmedEvent = event.trim();
                                if (trimmedEvent) {
                                    return `<div class="calendar-event" title="${escapeHTML(trimmedEvent)}">${escapeHTML(truncateText(trimmedEvent, 10))}</div>`;
                                }
                                return '';
                            }).join('');
                        }
                    }
                    
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        holidayClass = ' holiday';
                    }

                    dayEl.innerHTML = `<div class="day-number${holidayClass}">${date.getDate()}</div>
                                       ${cycleDayHtml}
                                       <div class="calendar-tasks">${eventsHtml}${tasksHtml}</div>`;
                    
                    return dayEl;
                };

                const firstDayOfMonth = new Date(year, month, 1);
                
                // Find the first Sunday to start the calendar grid on
                const startDate = new Date(firstDayOfMonth);
                startDate.setUTCDate(startDate.getUTCDate() - firstDayOfMonth.getUTCDay());
                startDate.setUTCHours(0,0,0,0);

                // Render 6 weeks
                for (let i = 0; i < 42; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setUTCDate(startDate.getUTCDate() + i);
                    
                    const isCurrentMonth = currentDate.getUTCMonth() === month;
                    calendarGrid.appendChild(generateDayElement(currentDate, isCurrentMonth));
                }
            }

            showListViewBtn.onclick = () => {
                listView.style.display = 'block';
                calendarView.style.display = 'none';
                showListViewBtn.classList.add('active');
                showCalendarViewBtn.classList.remove('active');
            };

            showCalendarViewBtn.onclick = () => {
                listView.style.display = 'none';
                calendarView.style.display = 'flex';
                showListViewBtn.classList.remove('active');
                showCalendarViewBtn.classList.add('active');
                renderCalendar();
            };

            prevMonthBtn.onclick = () => {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            };

            nextMonthBtn.onclick = () => {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            };

            // Initial Load
            loadTasks();
            checkReminders(); 
        });

        // --- SCHEDULE APP LOGIC ---
        (function() {
            const API_URL = 'https://iot.spyc.hk/timetable';
            let classTimetableData = null; 

            const modal = document.getElementById('class-modal');
            const classForm = document.getElementById('class-form');
            const classInput = document.getElementById('class-input');
            const scheduleSubtitle = document.getElementById('schedule-subtitle');

            const csvData = `Date,DayOfWeek,CycleDay,Type,Events
2025-09-01,Monday,,Special Timetable,"School Opening Ceremony"
2025-09-02,Tuesday,A,,Summer Timetable
2025-09-03,Wednesday,C,,Summer Timetable
2025-09-04,Thursday,F,,Summer Timetable
2025-09-05,Friday,B,,Summer Timetable
2025-09-06,Saturday,,,
2025-09-07,Sunday,,,
2025-09-08,Monday,D,,Summer Timetable
2025-09-09,Tuesday,E,,Summer Timetable
2025-09-10,Wednesday,G,,Summer Timetable
2025-09-11,Thursday,H,,Summer Timetable
2025-09-12,Friday,A,,Summer Timetable
2025-09-13,Saturday,,,
2025-09-14,Sunday,,Special Timetable,"Education Sunday"
2025-09-15,Monday,B,,Summer Timetable
2025-09-16,Tuesday,C,,Summer Timetable
2025-09-17,Wednesday,D,,Summer Timetable
2025-09-18,Thursday,E,,Summer Timetable
2025-09-19,Friday,F,,Summer Timetable
2025-09-20,Saturday,,,
2025-09-21,Sunday,,,
2025-09-22,Monday,G,,Summer Timetable
2025-09-23,Tuesday,H,,Summer Timetable
2025-09-24,Wednesday,A,,
2025-09-25,Thursday,B,,
2025-09-26,Friday,C,,
2025-09-27,Saturday,,,
2025-09-28,Sunday,,,
2025-09-29,Monday,,,
2025-09-30,Tuesday,,,
2025-10-01,Wednesday,,School Holiday,"The National Day"
2025-10-02,Thursday,F,,
2025-10-03,Friday,G,,
2025-10-04,Saturday,,,
2025-10-05,Sunday,,,
2025-10-06,Monday,H,,
2025-10-07,Tuesday,,School Holiday,"The day following the Mid-Autumn Festival"
2025-10-08,Wednesday,A,,
2025-10-09,Thursday,B,,
2025-10-10,Friday,C,,
2025-10-11,Saturday,,,
2025-10-12,Sunday,,,
2025-10-13,Monday,D,,
2025-10-14,Tuesday,E,,
2025-10-15,Wednesday,F,,
2025-10-16,Thursday,G,,
2025-10-17,Friday,H,,
2025-10-18,Saturday,,,
2025-10-19,Sunday,,,
2025-10-20,Monday,,Special Timetable,"Swimming Gala"
2025-10-21,Tuesday,A,,"S6 Study Day; Staff Development (pm)"
2025-10-22,Wednesday,B,,"S6 First Examination"
2025-10-23,Thursday,C,,"S6 First Examination"
2025-10-24,Friday,D,Special Timetable,"S6 First Examination; PTA AGM cum S1-4 Parents' Meet (7:00 pm)"
2025-10-25,Saturday,,,
2025-10-26,Sunday,,,
2025-10-27,Monday,E,,"S6 First Examination; S1-3 Test Week"
2025-10-28,Tuesday,F,,"S6 First Examination; S1-3 Test Week"
2025-10-29,Wednesday,,School Holiday,"S6 First Examination; S1-3 Test Week; Chung Yeung Festival"
2025-10-30,Thursday,,,"S6 First Examination; S1-3 Test Week"
2025-10-31,Friday,H,,"S6 First Examination; S1-3 Test Week"
2025-11-01,Saturday,,,
2025-11-02,Sunday,,,
2025-11-03,Monday,B,,"S6 First Examination"
2025-11-04,Tuesday,C,,"S6 First Examination"
2025-11-05,Wednesday,D,,"S6 First Examination"
2025-11-06,Thursday,E,,
2025-11-07,Friday,A,,"Mind Your Mind (Mental Health Day)"
2025-11-08,Saturday,,,
2025-11-09,Sunday,,,
2025-11-10,Monday,F,,
2025-11-11,Tuesday,G,,
2025-11-12,Wednesday,H,,
2025-11-13,Thursday,B,,
2025-11-14,Friday,C,,
2025-11-15,Saturday,,,
2025-11-16,Sunday,,,
2025-11-17,Monday,D,,"Seasonal Influenza Vaccination"
2025-11-18,Tuesday,F,,
2025-11-19,Wednesday,A,,
2025-11-20,Thursday,,Special Timetable,"School Picnic"
2025-11-21,Friday,,Special Timetable,"Staff Development Day"
2025-11-22,Saturday,,Special Timetable,"S1 Admission Info Day"
2025-11-23,Sunday,,,
2025-11-24,Monday,,School Holiday,"School Holiday"
2025-11-25,Tuesday,E,,
2025-11-26,Wednesday,G,,
2025-11-27,Thursday,,,
2025-11-28,Friday,B,,"School Picnic (Reserve)"
2025-11-29,Saturday,,Special Timetable,"S6 Parents' Day"
2025-11-30,Sunday,,,
2025-12-01,Monday,A,,"Gospel Week"
2025-12-02,Tuesday,C,,"Gospel Week"
2025-12-03,Wednesday,D,,"Gospel Week"
2025-12-04,Thursday,E,,"Gospel Week"
2025-12-05,Friday,F,,"Gospel Week"
2025-12-06,Saturday,,,
2025-12-07,Sunday,,,
2025-12-08,Monday,,School Holiday,"The day following the Legislative Council General Election"
2025-12-09,Tuesday,G,,
2025-12-10,Wednesday,H,,
2025-12-11,Thursday,A,,
2025-12-12,Friday,B,,
2025-12-13,Saturday,,,
2025-12-14,Sunday,,,
2025-12-15,Monday,C,,
2025-12-16,Tuesday,D,,
2025-12-17,Wednesday,E,,
2025-12-18,Thursday,G,,
2025-12-19,Friday,F,Special Timetable,"Christmas Service"
2025-12-20,Saturday,,,
2025-12-21,Sunday,,,
2025-12-22,Monday,,Special Timetable,"Christmas Celebration"
2025-12-23,Tuesday,,School Holiday,"Christmas & New Year Holidays"
2025-12-24,Wednesday,,School Holiday,"Christmas & New Year Holidays"
2025-12-25,Thursday,,School Holiday,"Christmas & New Year Holidays"
2025-12-26,Friday,,School Holiday,"Christmas & New Year Holidays"
2025-12-27,Saturday,,School Holiday,"Christmas & New Year Holidays"
2025-12-28,Sunday,,School Holiday,"Christmas & New Year Holidays"
2025-12-29,Monday,,School Holiday,"Christmas & New Year Holidays"
2025-12-30,Tuesday,,School Holiday,"Christmas & New Year Holidays"
2025-12-31,Wednesday,,School Holiday,"Christmas & New Year Holidays"
2026-01-01,Thursday,,School Holiday,"Christmas & New Year Holidays"
2026-01-02,Friday,H,,
2026-01-03,Saturday,,,
2026-01-04,Sunday,,,
2026-01-05,Monday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-06,Tuesday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-07,Wednesday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-08,Thursday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-09,Friday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-10,Saturday,,,
2026-01-11,Sunday,,,
2026-01-12,Monday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-13,Tuesday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-14,Wednesday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-15,Thursday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-16,Friday,,,"S1-5 First Examination; S6 Mock Examination"
2026-01-17,Saturday,,,
2026-01-18,Sunday,,,
2026-01-19,Monday,A,,"S6 Mock Examination"
2026-01-20,Tuesday,B,,"S6 Mock Examination"
2026-01-21,Wednesday,C,,
2026-01-22,Thursday,D,,
2026-01-23,Friday,E,,
2026-01-24,Saturday,,,
2026-01-25,Sunday,,,
2026-01-26,Monday,F,,
2026-01-27,Tuesday,G,,
2026-01-28,Wednesday,,,
2026-01-29,Thursday,A,,
2026-01-30,Friday,B,,
2026-01-31,Saturday,,,
2026-02-01,Sunday,,,
2026-02-02,Monday,C,,
2026-02-03,Tuesday,D,,
2026-02-04,Wednesday,E,,
2026-02-05,Thursday,F,,
2026-02-06,Friday,,Special Timetable,"Sports Days"
2026-02-07,Saturday,,,
2026-02-08,Sunday,,,
2026-02-09,Monday,,Special Timetable,"Sports Days"
2026-02-10,Tuesday,,School Holiday,"The day following Sports Days"
2026-02-11,Wednesday,G,,
2026-02-12,Thursday,H,,
2026-02-13,Friday,A,,"Farewell Activities for S6; Last Normal School Day for S6"
2026-02-14,Saturday,,,
2026-02-15,Sunday,,,
2026-02-16,Monday,,School Holiday,"Lunar New Year Holiday"
2026-02-17,Tuesday,,School Holiday,"Lunar New Year Holiday"
2026-02-18,Wednesday,,School Holiday,"Lunar New Year Holiday"
2026-02-19,Thursday,,School Holiday,"Lunar New Year Holiday"
2026-02-20,Friday,,School Holiday,"Lunar New Year Holiday"
2026-02-21,Saturday,,School Holiday,"Lunar New Year Holiday"
2026-02-22,Sunday,,School Holiday,"Lunar New Year Holiday"
2026-02-23,Monday,,School Holiday,"Lunar New Year Holiday"
2026-02-24,Tuesday,B,,
2026-02-25,Wednesday,,,
2026-02-26,Thursday,,,
2026-02-27,Friday,F,,"S1-5 Parents' Days (pm)"
2026-02-28,Saturday,,Special Timetable,"S1-5 Parents' Days"
2026-03-01,Sunday,,,
2026-03-02,Monday,,School Holiday,"The day following Parents' Days"
2026-03-03,Tuesday,E,,
2026-03-04,Wednesday,G,,
2026-03-05,Thursday,H,,
2026-03-06,Friday,A,,
2026-03-07,Saturday,,,
2026-03-08,Sunday,,,
2026-03-09,Monday,B,,"English Week"
2026-03-10,Tuesday,,,"English Week"
2026-03-11,Wednesday,,,"English Week"
2026-03-12,Thursday,,,"English Week"
2026-03-13,Friday,,,,"Staff Development Day"
2026-03-14,Saturday,,,
2026-03-15,Sunday,,,
2026-03-16,Monday,,,
2026-03-17,Tuesday,G,,
2026-03-18,Wednesday,H,,
2026-03-19,Thursday,F,,
2026-03-20,Friday,A,,"S1-3 Test Week; Staff Development (pm)"
2026-03-21,Saturday,,,"S1-3 Test Week"
2026-03-22,Sunday,,,"S1-3 Test Week"
2026-03-23,Monday,B,,"S1-3 Test Week"
2026-03-24,Tuesday,C,,"S1-3 Test Week"
2026-03-25,Wednesday,D,,"S1-3 Test Week"
2026-03-26,Thursday,E,,
2026-03-27,Friday,F,Special Timetable,"Easter Service"
2026-03-28,Saturday,,,
2026-03-29,Sunday,,,
2026-03-30,Monday,,Special Timetable,"Other Learning Experiences (OLE) Days"
2026-03-31,Tuesday,,Special Timetable,"Other Learning Experiences (OLE) Days"
2026-04-01,Wednesday,,Special Timetable,"Other Learning Experiences (OLE) Days"
2026-04-02,Thursday,,School Holiday,"Easter Holiday"
2026-04-03,Friday,,School Holiday,"Easter Holiday"
2026-04-04,Saturday,,School Holiday,"Easter Holiday"
2026-04-05,Sunday,,School Holiday,"Easter Holiday"
2026-04-06,Monday,,School Holiday,"Easter Holiday; The day following Ching Ming Festival"
2026-04-07,Tuesday,,School Holiday,"Easter Holiday"
2026-04-08,Wednesday,,School Holiday,"Easter Holiday"
2026-04-09,Thursday,,School Holiday,"Easter Holiday"
2026-04-10,Friday,,School Holiday,"Easter Holiday"
2026-04-11,Saturday,,School Holiday,"Easter Holiday"
2026-04-12,Sunday,,,
2026-04-13,Monday,G,,
2026-04-14,Tuesday,H,,
2026-04-15,Wednesday,A,,
2026-04-16,Thursday,B,,
2026-04-17,Friday,C,,
2026-04-18,Saturday,,,
2026-04-19,Sunday,,,
2026-04-20,Monday,D,,
2026-04-21,Tuesday,E,,
2026-04-22,Wednesday,G,,
2026-04-23,Thursday,F,,
2026-04-24,Friday,,Special Timetable,"School Anniversary Celebration"
2026-04-25,Saturday,,,
2026-04-26,Sunday,,,
2026-04-27,Monday,H,,
2026-04-28,Tuesday,A,,
2026-04-29,Wednesday,B,,
2026-04-30,Thursday,C,,
2026-05-01,Friday,,School Holiday,"Labour Day"
2026-05-02,Saturday,,,
2026-05-03,Sunday,,,
2026-05-04,Monday,D,,
2026-05-05,Tuesday,E,,
2026-05-06,Wednesday,G,,
2026-05-07,Thursday,H,,
2026-05-08,Friday,A,,
2026-05-09,Saturday,,,
2026-05-10,Sunday,,,
2026-05-11,Monday,,,
2026-05-12,Tuesday,,,
2026-05-13,Wednesday,,,
2026-05-14,Thursday,,,
2026-05-15,Friday,F,,"Summer Timetable"
2026-05-16,Saturday,,Special Timetable,"Summer Timetable; Speech Day"
2026-05-17,Sunday,,,
2026-05-18,Monday,G,,"Summer Timetable"
2026-05-19,Tuesday,H,,"Summer Timetable"
2026-05-20,Wednesday,A,,"Summer Timetable"
2026-05-21,Thursday,B,,"Summer Timetable"
2026-05-22,Friday,C,,"Summer Timetable"
2026-05-23,Saturday,,,
2026-05-24,Sunday,,,
2026-05-25,Monday,,School Holiday,"Summer Timetable; The day following the Birthday of the Buddha"
2026-05-26,Tuesday,,,"Summer Timetable"
2026-05-27,Wednesday,,,"Summer Timetable"
2026-05-28,Thursday,,,"Summer Timetable"
2026-05-29,Friday,,,
2026-05-30,Saturday,,,
2026-05-31,Sunday,,,
2026-06-01,Monday,H,,
2026-06-02,Tuesday,A,,
2026-06-03,Wednesday,,,"S1-5 Final Examination"
2026-06-04,Thursday,,,"S1-5 Final Examination"
2026-06-05,Friday,,,"S1-5 Final Examination"
2026-06-06,Saturday,,,
2026-06-07,Sunday,,,
2026-06-08,Monday,,,"S1-5 Final Examination"
2026-06-09,Tuesday,,,"S1-5 Final Examination"
2026-06-10,Wednesday,,,"S1-5 Final Examination"
2026-06-11,Thursday,,,"S1-5 Final Examination"
2026-06-12,Friday,,,"S1-5 Final Examination"
2026-06-13,Saturday,,,
2026-06-14,Sunday,,,
2026-06-15,Monday,,,"S1-5 Final Examination"
2026-06-16,Tuesday,,,"S1-5 Final Examination"
2026-06-17,Wednesday,,,"S1-5 Final Examination; S3 TSA (written)"
2026-06-18,Thursday,,,"S1-5 Final Examination; S3 TSA (written)"
2026-06-19,Friday,,School Holiday,"Tuen Ng Festival"
2026-06-20,Saturday,,,
2026-06-21,Sunday,,,
2026-06-22,Monday,,Special Timetable,"S1-5 Final Examination (Reserve); Staff Development Day"
2026-06-23,Tuesday,,Special Timetable,"Markers' Meetings"
2026-06-24,Wednesday,,,"S3 TSA (written) (Reserve); S1-5 Post-Exam Feedback Days"
2026-06-25,Thursday,,,"S1-5 Post-Exam Feedback Days"
2026-06-26,Friday,,,"S1-5 Post-Exam Feedback Days"
2026-06-27,Saturday,,,
2026-06-28,Sunday,,,
2026-06-29,Monday,,Special Timetable,"Musical Rehearsal"
2026-06-30,Tuesday,,Special Timetable,"Musical Rehearsal"
2026-07-01,Wednesday,,School Holiday,"Musical Rehearsal; HKSAR Establishment Day"
2026-07-02,Thursday,,Special Timetable,"Musical Rehearsal; Teachers' Meetings / Promotion Meetings"
2026-07-03,Friday,,Special Timetable,"Musical Rehearsal; General Staff Meeting"
2026-07-04,Saturday,,,
2026-07-05,Sunday,,,
2026-07-06,Monday,,Special Timetable,"Musical Shows"
2026-07-07,Tuesday,,Special Timetable,"Musical Shows; Release of SSPA Results"
2026-07-08,Wednesday,,Special Timetable,"Musical Shows"
2026-07-09,Thursday,,,"Musical Shows (Reserve); S4-5 Supplementary Lessons/SBA"
2026-07-10,Friday,,,"S4-5 Supplementary Lessons/SBA"
2026-07-11,Saturday,,,
2026-07-12,Sunday,,,
2026-07-13,Monday,,Special Timetable,"School Closing Ceremony"
2026-07-14,Tuesday,,School Holiday,"Summer Vacation; School Closing Ceremony (Reserve); Pre-S1 Hong Kong Attainment Test; S4-5 Re-exam"
2026-07-15,Wednesday,,School Holiday,"Summer Vacation; S4-5 Re-exam; Release of HKDSE Exam Results (S6)"
2026-07-16,Thursday,,School Holiday,"Summer Vacation; Careers Counselling (S6); S4-5 SBA"
2026-07-17,Friday,,School Holiday,"Summer Vacation; S4-5 SBA (Reserve)"
2026-07-18,Saturday,,School Holiday,"Summer Vacation"
2026-07-19,Sunday,,School Holiday,"Summer Vacation"
2026-07-20,Monday,,School Holiday,"Summer Vacation"
2026-07-21,Tuesday,,School Holiday,"Summer Vacation"
2026-07-22,Wednesday,,School Holiday,"Summer Vacation"
2026-07-23,Thursday,,School Holiday,"Summer Vacation"
2026-07-24,Friday,,School Holiday,"Summer Vacation"
2026-07-25,Saturday,,School Holiday,"Summer Vacation"
2026-07-26,Sunday,,School Holiday,"Summer Vacation"
2026-07-27,Monday,,School Holiday,"Summer Vacation"
2026-07-28,Tuesday,,School Holiday,"Summer Vacation; Release of S3 Subject Selection Results (tentative)"
2026-07-29,Wednesday,,School Holiday,"Summer Vacation"
2026-07-30,Thursday,,School Holiday,"Summer Vacation"
2026-07-31,Friday,,School Holiday,"Summer Vacation"
2026-08-01,Saturday,,School Holiday,"Summer Vacation"
2026-08-02,Sunday,,School Holiday,"Summer Vacation"
2026-08-03,Monday,,School Holiday,"Summer Vacation"
2026-08-04,Tuesday,,School Holiday,"Summer Vacation"
2026-08-05,Wednesday,,School Holiday,"Summer Vacation"
2026-08-06,Thursday,,School Holiday,"Summer Vacation"
2026-08-07,Friday,,School Holiday,"Summer Vacation"
2026-08-08,Saturday,,School Holiday,"Summer Vacation"
2026-08-09,Sunday,,School Holiday,"Summer Vacation"
2026-08-10,Monday,,School Holiday,"Summer Vacation"
2026-08-11,Tuesday,,School Holiday,"Summer Vacation"
2026-08-12,Wednesday,,School Holiday,"Summer Vacation"
2026-08-13,Thursday,,School Holiday,"Summer Vacation"
2026-08-14,Friday,,School Holiday,"Summer Vacation"
2026-08-15,Saturday,,School Holiday,"Summer Vacation"
2026-08-16,Sunday,,School Holiday,"Summer Vacation"
2026-08-17,Monday,,School Holiday,"Summer Vacation"
2026-08-18,Tuesday,,School Holiday,"Summer Vacation"
2026-08-19,Wednesday,,School Holiday,"Summer Vacation"
2026-08-20,Thursday,,School Holiday,"Summer Vacation"
2026-08-21,Friday,,School Holiday,"Summer Vacation"
2026-08-22,Saturday,,School Holiday,"Summer Vacation"
2026-08-23,Sunday,,School Holiday,"Summer Vacation"
2026-08-24,Monday,,School Holiday,"Summer Vacation"
2026-08-25,Tuesday,,School Holiday,"Summer Vacation"
2026-08-26,Wednesday,,School Holiday,"Summer Vacation"
2026-08-27,Thursday,,School Holiday,"Summer Vacation"
2026-08-28,Friday,,School Holiday,"Summer Vacation"
2026-08-29,Saturday,,School Holiday,"Summer Vacation"
2026-08-30,Sunday,,School Holiday,"Summer Vacation"
2026-08-31,Monday,,School Holiday,"Summer Vacation"`;
            function parseCSV(csvText) { const lines = csvText.trim().split('\n'); const headers = lines[0].split(','); const data = []; for (let i = 1; i < lines.length; i++) { const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); if (values.length === headers.length) { const entry = {}; for (let j = 0; j < headers.length; j++) { entry[headers[j]] = values[j].replace(/"/g, ''); } data.push(entry); } } return data; }
            function formatDisplayDate(date) { return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
            function formatLookupDate(date) { 
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const d = date.getDate().toString().padStart(2, '0');
                return `${y}-${m}-${d}`;
            }
            function renderEvents(element, eventsForDay) { if (!eventsForDay || eventsForDay.length === 0) { element.innerHTML = '<p class="text-gray-500 italic">No events scheduled.</p>'; return; } const event = eventsForDay[0]; let html = ''; if (event.CycleDay) { html += `<div class="flex items-center bg-gray-50 p-3 rounded-lg"><span class="bg-gray-200 text-gray-700 text-sm font-bold mr-3 px-2.5 py-1 rounded-full">Cycle Day</span><span class="text-gray-800 font-semibold">${event.CycleDay}</span></div>`; } if (event.Type) { html += `<div class="flex items-center bg-blue-50 p-3 rounded-lg"><span class="bg-blue-100 text-blue-800 text-sm font-bold mr-3 px-2.5 py-1 rounded-full">Type</span><span class="text-gray-800">${event.Type}</span></div>`; } if (event.Events) { const eventItems = event.Events.split(';').map(e => e.trim()).join('<br>'); html += `<div class="flex items-start bg-green-50 p-3 rounded-lg"><span class="bg-green-100 text-green-800 text-sm font-bold mr-3 px-2.5 py-1 rounded-full whitespace-nowrap">Events</span><span class="text-gray-800">${eventItems}</span></div>`; } element.innerHTML = html || '<p class="text-gray-500 italic">No specific events listed.</p>'; }
            
            function renderTimetable(element, eventData) {
                if (!eventData || !eventData.CycleDay || !classTimetableData || !classTimetableData[eventData.CycleDay]) {
                    element.innerHTML = ''; return;
                }
                const cycleDay = eventData.CycleDay;
                const schedule = classTimetableData[cycleDay];
                let tableHtml = `<h3 class="text-xl font-bold text-gray-700 mt-6 mb-3">Timetable (Day ${cycleDay})</h3><div class="overflow-x-auto rounded-lg border border-gray-200"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                
                schedule.forEach(item => {
                    let subject = item.subject || "";
                    const match = subject.match(/\[([1-3]X)\]/);
                    if (match) {
                        subject = match[1];
                    }
                    if (subject.toLowerCase().includes('recess') || subject.toLowerCase().includes('lunch')) {
                        tableHtml += `<tr><td class="px-4 py-2 text-center bg-gray-100 font-medium text-sm text-gray-600">${subject}</td></tr>`;
                    } else {
                        tableHtml += `<tr><td class="px-4 py-3 whitespace-pre-wrap text-sm text-gray-600">${subject}</td></tr>`;
                    }
                });
                tableHtml += `</tbody></table></div>`;
                element.innerHTML = tableHtml;
            }

            async function fetchAndRenderSchedule(userClass) {
                scheduleSubtitle.textContent = `Loading schedule for class ${userClass}...`;
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error(`Network response error`);
                    const data = await response.json();

                    if (!data[userClass]) {
                        alert(`Class "${userClass}" not found. Please try again.`);
                        localStorage.removeItem('userClass');
                        modal.style.display = 'flex';
                        scheduleSubtitle.textContent = "Please enter your class to begin.";
                        return;
                    }
                    classTimetableData = data[userClass];
                    scheduleSubtitle.textContent = `Showing schedule for class ${userClass}.`;
                    
                    const allEvents = parseCSV(csvData);
                    const today = new Date(); 
                    const tomorrow = new Date();
                    tomorrow.setDate(today.getDate() + 1);

                    document.getElementById('today-date').textContent = formatDisplayDate(today);
                    document.getElementById('tomorrow-date').textContent = formatDisplayDate(tomorrow);

                    const todaysEvents = allEvents.filter(e => e.Date === formatLookupDate(today));
                    const tomorrowsEvents = allEvents.filter(e => e.Date === formatLookupDate(tomorrow));

                    renderEvents(document.getElementById('today-events'), todaysEvents);
                    renderTimetable(document.getElementById('today-timetable'), todaysEvents.length > 0 ? todaysEvents[0] : null);

                    renderEvents(document.getElementById('tomorrow-events'), tomorrowsEvents);
                    renderTimetable(document.getElementById('tomorrow-timetable'), tomorrowsEvents.length > 0 ? tomorrowsEvents[0] : null);

                } catch (error) {
                    console.error('Failed to fetch timetable:', error);
                    scheduleSubtitle.textContent = "Could not load schedule. Please try again later.";
                    alert("Error fetching schedule. Please check your internet or try again.");
                }
            }

            classForm.onsubmit = (e) => {
                e.preventDefault();
                const userClass = classInput.value.trim().toUpperCase();
                if (userClass) {
                    localStorage.setItem('userClass', userClass);
                    modal.style.display = 'none';
                    fetchAndRenderSchedule(userClass);
                }
            };
            
            document.addEventListener("DOMContentLoaded", () => {
                const savedClass = localStorage.getItem('userClass');
                const hasVisited = localStorage.getItem('hasVisitedBefore');

                if (savedClass) {
                    fetchAndRenderSchedule(savedClass);
                } else if (hasVisited) {
                    modal.style.display = 'flex';
                    scheduleSubtitle.textContent = "Please enter your class to begin.";
                } else {
                    scheduleSubtitle.textContent = "Please enter your class to begin.";
                }
            });
        })();
    </script>
</body>
</html>

